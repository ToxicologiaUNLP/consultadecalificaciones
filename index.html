<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Notas Toxicología UNLP</title>
  <link rel="icon" href="logo2.png" type="image/png">

  <link href="https://fonts.googleapis.com/css2?family=Open+Sans&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;800&display=swap" rel="stylesheet">

  <style>
    /* (mismo estilo, omito aquí para no repetir) */
  </style>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
</head>
<body>
  <header>
    <img src="logo.png" alt="Logo Cátedra" class="logo-izq" />
    <h1 class="titulo-centro">Plataforma de acceso a calificaciones</h1>
    <img src="logo1.png" alt="Logo Derecho" class="logo-der pequeño" />
  </header>

  <main id="contenido">
    <p style="color: black;">Ingrese sus datos de la forma solicitada y el sistema le brindará la información.</p>

    <label for="legajo">Ingrese su legajo:</label>
    <input type="text" id="legajo" placeholder="12345/6" autocomplete="off" />

    <label for="email">Ingrese su email asociado al SIU Guaraní*:</label>
    <input type="email" id="email" placeholder="alumno@gmail.com" autocomplete="off" />
    <small style="color:#555; font-size:0.9em;">
      *Correo electrónico que usted ha seleccionado para recibir información oficial de las cátedras. Esto permitirá acceder a sus notas de forma personal.
    </small>

    <button onclick="buscarNota()">Consultar</button>
    <div id="resultado"></div>
    <div id="error"></div>
  </main>

  <footer>
    © 2025 Cátedra de Toxicología, Facultad de Ciencias Médicas - UNLP. Todos los derechos reservados.
  </footer>

<script>
  const urlBase = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vReNWOvv7g2rK58C0Ari6MtMo8LT1Si1hYRm_hueR-ad88Utj6TlK0wfMyJJEHv1Q/pub?gid=919817434&single=true&output=csv';
  const urlConfig = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vReNWOvv7g2rK58C0Ari6MtMo8LT1Si1hYRm_hueR-ad88Utj6TlK0wfMyJJEHv1Q/pub?gid=741334934&single=true&output=csv';

  async function verificarEstado() {
    try {
      const resp = await fetch(urlConfig + '&_ts=' + Date.now());
      const texto = await resp.text();
      console.log("Configuración CSV:", texto);
      const parsed = Papa.parse(texto, { header: true });
      const estado = parsed.data[0]?.estado?.trim().toLowerCase();
      console.log("Estado leído:", estado);
      if (estado !== 'habilitado') {
        document.getElementById('contenido').innerHTML = `
          <p style="color:red; font-weight:bold; font-size:1.2em; text-align:center;">
            La plataforma no se encuentra habilitada debido a la carga de datos. Estará disponible nuevamente al finalizar el proceso.
          </p>
        `;
      }
    } catch (e) {
      console.error("Error verificando estado:", e);
    }
  }

  async function cargarDatos(url) {
    try {
      const response = await fetch(url);
      const text = await response.text();
      console.log("Datos CSV:", text.slice(0, 500)); // mostrar primeros 500 caracteres para no saturar consola
      const parsed = Papa.parse(text, { header: true, skipEmptyLines: true });
      return parsed;
    } catch(e) {
      console.error("Error cargando datos:", e);
      throw e;
    }
  }

  async function buscarNota() {
    const legajoInput = document.getElementById('legajo').value.trim().toLowerCase();
    const emailInput = document.getElementById('email').value.trim().toLowerCase();
    const resultado = document.getElementById('resultado');
    const errorDiv = document.getElementById('error');
    resultado.innerHTML = "";
    errorDiv.textContent = "";

    if (!legajoInput || !emailInput) {
      errorDiv.textContent = "Por favor, ingrese legajo y email.";
      return;
    }

    try {
      const urlConTimestamp = urlBase + '&_ts=' + Date.now();
      const parsed = await cargarDatos(urlConTimestamp);

      console.log("Campos en CSV:", parsed.meta.fields);
      console.log("Cantidad filas:", parsed.data.length);

      const fila = parsed.data.find(row => {
        console.log("Comparando fila:", row);
        return row['Legajo'] && row['Email'] &&
          row['Legajo'].trim().toLowerCase() === legajoInput &&
          row['Email'].trim().toLowerCase() === emailInput;
      });

      if (!fila) {
        errorDiv.textContent = "Datos incorrectos. Verifique legajo/email.";
        return;
      }

      const nombre = fila['Alumno'] || "Alumno";
      const columnasExcluir = ['legajo', 'nombre', 'apellido', 'nombre y apellido', 'alumno', 'email'];

      let tablaHTML = '<p><strong>Hola ' + nombre + ', tus notas son:</strong></p><div class="tabla-scroll"><table><thead><tr>';
      parsed.meta.fields.forEach(col => {
        if (!columnasExcluir.includes(col.toLowerCase())) tablaHTML += '<th>' + col + '</th>';
      });
      tablaHTML += '</tr></thead><tbody><tr>';
      parsed.meta.fields.forEach(col => {
        if (!columnasExcluir.includes(col.toLowerCase())) tablaHTML += '<td>' + (fila[col] || '-') + '</td>';
      });
      tablaHTML += '</tr></tbody></table></div>';
      tablaHTML += '<p style="margin-top:2em; color:#000; font-size:0.95em;">Contacto: <strong>toxicoalumnos@gmail.com</strong></p>';
      resultado.innerHTML = tablaHTML;

    } catch (e) {
      console.error("Error en buscarNota:", e);
      errorDiv.textContent = "Error al cargar los datos. Intente nuevamente.";
    }
  }

  document.addEventListener('DOMContentLoaded', verificarEstado);
</script>
</body>
</html>
