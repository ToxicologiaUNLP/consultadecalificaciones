<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Asistencia y Calificaciones - Toxicología UNLP</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<link rel="icon" href="logo1.png" type="image/png" />

<link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;800&display=swap" rel="stylesheet">

<style>
* { box-sizing: border-box; }
html, body { height: 100%; margin: 0; }

body {
  font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
  background: linear-gradient(135deg, #087882 0%, #0c8c9c 40%, #045c63 70%, #04545d 100%);
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  overflow-x: hidden;
}

main {
  max-width: 600px;
  width: 100%;
  background: #f9f8f5;
  margin: 30px auto 2em auto;
  padding: 2em;
  border-radius: 16px;
  box-shadow: 0 8px 25px rgba(0,0,0,0.2);
  flex: 1;
}

main header { text-align: center; margin-bottom: 25px; }
main header img { width: 100%; height: auto; border-radius: 16px; box-shadow: 0 3px 8px rgba(0,0,0,0.18); }

.titulo-centro {
  font-family: 'Open Sans', sans-serif;
  font-weight: 700;
  font-size: 2em;
  color: #38828f;
  margin: 20px 0 0 0;
}

label { font-weight: 600; margin-top: 1em; margin-bottom: 0.6em; display: block; }
input { width: 100%; padding: 0.7em; font-size: 1.05em; border: 2px solid #ccc; border-radius: 8px; }

button { border-radius: 6px; font-weight: 700; cursor: pointer; margin: 1em auto 0 auto; display: block; border: none; transition: opacity 0.2s; }
#btnConsultar, #btnVolver { background: #2d8390; color: white; }
#btnConsultar { padding: 0.6em 1.5em; font-size: 1.1em; }
#btnVolver { padding: 0.45em 0.9em; font-size: 0.85em; }

/* === CARTEL DE ESTADO === */
.alerta-estado {
  padding: 15px; border-radius: 12px; margin-bottom: 20px; text-align: center;
  font-family: 'Montserrat', sans-serif; font-weight: 800; border: 2px solid transparent;
}
.estado-libre { background: #ffebee; border-color: #ef9a9a; color: #c62828; }
.estado-regular { background: #fff3e0; border-color: #ffcc80; color: #e65100; }
.estado-promocion { background: #e8f5e9; border-color: #a5d6a7; color: #2e7d32; }

/* === CARGA SIMULADA === */
#loader { display: none; text-align: center; padding: 2em 0; }
.spinner {
  width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #38828f;
  border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 15px auto;
}
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
#loaderText { font-family: 'Montserrat', sans-serif; color: #38828f; font-weight: 700; font-size: 0.9em; }

/* === BLOQUES DE RESULTADOS === */
.categoria-bloque {
  margin-bottom: 15px; background: #fff; border-radius: 10px; padding: 15px; border: 1px solid #e0e6e7; border-left: 5px solid #38828f;
}
.categoria-titulo { font-family: 'Montserrat', sans-serif; font-size: 0.85em; color: #38828f; font-weight: 800; margin-bottom: 12px; text-transform: uppercase; }
.grid-datos { display: grid; grid-template-columns: repeat(auto-fill, minmax(75px, 1fr)); gap: 8px; }
.dato-item { background: #f4f8f9; border: 1px solid #d1dfe1; padding: 10px 4px; border-radius: 6px; text-align: center; }
.dato-label { display: block; font-size: 0.65em; color: #668a90; font-weight: 700; }
.dato-valor { display: block; font-size: 1.1em; font-weight: 800; color: #2c565d; }

.aclaracion-chiquita { font-size: 0.65em; color: #999; margin-top: 8px; font-style: italic; }

.promocion { background-color: #e8f5e9 !important; border-color: #a5d6a7 !important; }
.promocion .dato-valor { color: #2e7d32 !important; }
.desaprobado { background-color: #ffebee !important; border-color: #ef9a9a !important; }
.desaprobado .dato-valor { color: #c62828 !important; }

.seccion-referencias { margin-top: 20px; padding: 12px; background: #eee; border-radius: 8px; font-size: 0.75em; color: #666; line-height: 1.4; }
.info-institucional { margin-top: 1.5em; text-align: center; font-family: "Courier New", Courier, "Lucida Console", Monaco, monospace; font-size: 0.74em; line-height: 1.3; color: #888; }
.link-condiciones { color: #38828f; text-decoration: underline; font-weight: 600; }

footer { color: #ffffff; text-align: center; padding: 1em; font-size: 0.85em; margin-top: auto; }

@media (max-width: 600px) { main { width: 100%; margin: 0; border-radius: 0; } }
</style>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
</head>

<body>
<main>
  <header>
    <img src="logop.png" alt="Logo Cátedra" />
    <div class="titulo-centro">ASISTENCIA Y CALIFICACIONES</div>
  </header>
  <div id="contenido"></div>
  <div id="loader">
    <div class="spinner"></div>
    <div id="loaderText">Consultando base de datos...</div>
  </div>
</main>

<footer>© 2026 Cátedra de Toxicología, FCM - UNLP.</footer>

<script>
const urlBase = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vReNWOvv7g2rK58C0Ari6MtMo8LT1Si1hYRm_hueR-ad88Utj6TlK0wfMyJJEHv1Q/pub?output=csv';

async function cargarDatos(url) {
  const res = await fetch(url, { cache: "no-store" });
  const text = await res.text();
  return Papa.parse(text, { header: true, skipEmptyLines: true, delimiter: "," });
}

async function verificarEstado() {
  const datos = await cargarDatos(urlBase + '&_ts=' + Date.now());
  const filaEstado = datos.data.find(row => row.Estado && row.Estado.trim() !== "");
  const estado = filaEstado?.Estado?.trim().toLowerCase();
  const contenido = document.getElementById('contenido');

  if (estado === 'habilitado') {
    contenido.innerHTML = `
      <div id="formBuscador">
        <p style="color:black; margin:0.5em 0;">Ingrese sus datos de la forma solicitada y el sistema le brindará la información.</p>
        <label for="legajo">Legajo</label><input type="text" id="legajo" placeholder="12345/6" />
        <label for="email">E-mail asociado al SIU Guaraní*</label><input type="email" id="email" placeholder="alumno@gmail.com" />
        <small style="color:#555; font-size:0.9em;">*Correo electrónico elegido para recibir información desde las cátedras.</small>
        <button id="btnConsultar">Acceder</button>
      </div>
      <div id="resultado"></div>
      <div id="error" style="color:red; text-align:center; margin-top:10px;"></div>`;
    document.getElementById('btnConsultar').onclick = buscarNota;
  } else {
    contenido.innerHTML = `<div style="text-align:center; margin:2em; font-weight:bold;">En este momento no es posible acceder.</div>`;
  }
}

function calcularEstadoAcademico(fila) {
  // 1. Asistencia
  const contarFaltas = (p) => Object.keys(fila).filter(k => k.toUpperCase().startsWith(p) && !["°", "F", "PARCIAL", "PFI", "TECP"].some(ex => k.toUpperCase().includes(ex)) && fila[k].toUpperCase() === 'A').length;
  const fT = contarFaltas('T'), fP = contarFaltas('P'), fAE = contarFaltas('AE'), fS = contarFaltas('S');
  const totalF = fT + fP + fAE;

  // 2. Evaluaciones específicas
  const nota1ra = parseFloat(fila['P1°F']) || 0;
  const notaPFI = parseFloat(fila['PFI']) || 0;
  const tecpOk = !Object.keys(fila).some(k => k.startsWith('TECP') && (fila[k].toUpperCase() === 'D' || fila[k].toUpperCase() === 'A'));

  // 3. Mejores notas para regularidad
  const todasNotas = Object.keys(fila).filter(k => k.includes('PARCIAL') || k.includes('°') || k.includes('F'))
                       .map(k => parseFloat(fila[k])).filter(n => !isNaN(n));
  const mejorNota = todasNotas.length > 0 ? Math.max(...todasNotas) : 0;

  // Lógica LIBRE
  if (fS > 0 || fT > 2 || fP > 2 || fAE > 2 || totalF > 4) {
    return { clase: 'estado-libre', texto: 'SITUACIÓN: LIBRE', desc: 'Incumplimiento de asistencia u obligatoriedad.' };
  }

  // Lógica PROMOCIÓN (Específica: 1ra fecha >=7, PFI >=7, TECP ok)
  if (nota1ra >= 7 && notaPFI >= 7 && tecpOk) {
    return { clase: 'estado-promocion', texto: 'SITUACIÓN: PROMOCIÓN', desc: 'Promocionado. Cumple 1ra fecha, PFI y asistencias.' };
  }

  // Lógica REGULAR
  if (mejorNota >= 4 && todasNotas.length <= 3) {
    return { clase: 'estado-regular', texto: 'SITUACIÓN: REGULAR', desc: 'Cursada aprobada (con final). No cumple requisitos de promoción.' };
  }

  return { clase: 'estado-regular', texto: 'SITUACIÓN: EN CURSADA', desc: 'Mantenga asistencia y actividades para definir su condición.' };
}

async function buscarNota(){
  const legajo = document.getElementById('legajo').value.trim().toLowerCase();
  const email = document.getElementById('email').value.trim().toLowerCase();
  const resDiv = document.getElementById('resultado');
  const errorDiv = document.getElementById('error');
  const formBuscador = document.getElementById('formBuscador');
  const loader = document.getElementById('loader');

  errorDiv.textContent = "";
  if(!legajo || !email) { errorDiv.textContent = "Complete ambos campos."; return; }

  formBuscador.style.display = 'none';
  loader.style.display = 'block';

  const parsed = await cargarDatos(urlBase + '&_ts=' + Date.now());
  const columnas = parsed.meta.fields;
  const fila = parsed.data.find(row => row['Legajo']?.trim().toLowerCase() === legajo && row['Email']?.trim().toLowerCase() === email);

  setTimeout(() => {
    loader.style.display = 'none';
    if(!fila) {
      formBuscador.style.display = 'block';
      errorDiv.textContent = "Datos incorrectos. Verifique e intente nuevamente.";
      return;
    }

    const estado = calcularEstadoAcademico(fila);
    const nombreEstudiante = fila[columnas[0]] || "Estudiante";
    
    let html = `<div class="alerta-estado ${estado.clase}">${estado.texto}<br><small style="font-weight:400">${estado.desc}</small></div>`;
    html += `<p><strong>${nombreEstudiante}:</strong></p>`;
    
    html += generarBloque(fila, "T", "Teóricos", ["TECP"], "A: Ausente | P: Presente");
    html += generarBloque(fila, "P", "Trabajos Prácticos", ["°", "F", "PARCIAL", "PFI"], "A: Ausente | P: Presente");
    html += generarBloque(fila, "S", "Simulación", [], "A: Ausente | P: Presente");
    html += generarBloqueAE(fila);
    html += generarBloqueEvaluacion(fila);

    html += `
      <div class="seccion-referencias">
        <strong>Referencias:</strong> T: Teóricos | P: Prácticos | S: Simulación | AE: Autoevaluación | PFI: Parcial Final Integrador | TECP: Taller Evaluación Continua | °/F: Fechas Parcial.
      </div>
      <button id="btnVolver">Volver</button>
      <p class="info-institucional">Sujeto a las <a href="https://educativa.med.unlp.edu.ar/course/view.php?id=290" target="_blank" class="link-condiciones">condiciones</a> establecidas por la cátedra.</p>
    `;

    resDiv.innerHTML = html;
    document.getElementById('btnVolver').onclick = () => { location.reload(); };
  }, 1500);
}

function generarBloque(fila, prefijo, titulo, excluir = [], aclaracion = "") {
  const columnas = Object.keys(fila).filter(col => {
    const c = col.toUpperCase();
    return c.startsWith(prefijo.toUpperCase()) && !excluir.some(ex => c.includes(ex.toUpperCase())) && fila[col]?.trim() !== "";
  });
  if (columnas.length === 0) return "";
  let b = `<div class="categoria-bloque"><div class="categoria-titulo">${titulo}</div><div class="grid-datos">`;
  columnas.forEach(c => { 
    const val = fila[c].trim().toUpperCase();
    let clase = (val === "A") ? "desaprobado" : "";
    b += `<div class="dato-item ${clase}"><span class="dato-label">${c}</span><span class="dato-valor">${fila[c]}</span></div>`; 
  });
  b += `</div><div class="aclaracion-chiquita">${aclaracion}</div></div>`;
  return b;
}

function generarBloqueAE(fila) {
  const columnas = Object.keys(fila).filter(col => col.toUpperCase().startsWith("AE") && fila[col]?.trim() !== "");
  if (columnas.length === 0) return "";
  let b = `<div class="categoria-bloque" style="border-left-color: #c96d00;"><div class="categoria-titulo" style="color: #c96d00;">Autoevaluaciones Asincrónicas (Obligatorias)</div><div class="grid-datos">`;
  columnas.forEach(c => {
    const val = fila[c].trim().toUpperCase();
    let clase = (val === "A" || val === "D") ? "desaprobado" : "promocion";
    b += `<div class="dato-item ${clase}"><span class="dato-label">${c}</span><span class="dato-valor">${fila[c]}</span></div>`;
  });
  b += `</div><div class="aclaracion-chiquita">Deben estar todas completas para mantener la regularidad.</div></div>`;
  return b;
}

function generarBloqueEvaluacion(fila) {
  const columnas = Object.keys(fila).filter(col => {
    const c = col.toUpperCase();
    return (c.includes("°") || c.includes("F") || c.includes("PARCIAL") || c.startsWith("PFI") || c.startsWith("TECP")) && fila[col]?.trim() !== "";
  });
  if (columnas.length === 0) return "";
  let b = `<div class="categoria-bloque"><div class="categoria-titulo">EVALUACIONES</div><div class="grid-datos">`;
  columnas.forEach(c => {
    const val = fila[c].trim();
    const num = parseFloat(val);
    let clase = "";
    if (val.toUpperCase() === "D" || val.toUpperCase() === "A" || (!isNaN(num) && num < 4)) clase = "desaprobado";
    else if (!isNaN(num) && num >= 7) clase = "promocion";
    b += `<div class="dato-item ${clase}"><span class="dato-label">${c}</span><span class="dato-valor">${val}</span></div>`;
  });
  b += `</div><div class="aclaracion-chiquita">A: Aprobado | D: Desaprobado | 7 o más: Promoción (según requisitos)</div></div>`;
  return b;
}

window.onload = verificarEstado;
</script>
</body>
</html>























































































































































































































































































































































































































































































































































































































































































































































































































































































































