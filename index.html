<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Notas Toxicología UNLP</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="icon" href="logo1.png" type="image/png" />

  <link href="https://fonts.googleapis.com/css2?family=Open+Sans&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;800&display=swap" rel="stylesheet">

  <style>
    html, body { height:100%; width:100%; margin:0; padding:0; }
    body { font-family:"Segoe UI", Tahoma, Geneva, Verdana, sans-serif; background:#f9f9f9; display:flex; flex-direction:column; min-height:100vh; }
    header { display:flex; flex-direction:column; justify-content:center; align-items:center; padding:20px; }
    header img { width:100%; max-width:660px; height:auto; }
    .titulo-centro { font-family:'Open Sans',sans-serif; font-weight:700; font-size:2.2em; color:#38828f; text-align:center; margin:20px 0 0 0; line-height:1.2em; user-select:none; }
    main { max-width:600px; background:white; margin:0 auto 2em auto; padding:2em; border-radius:10px; box-shadow:0 2px 8px rgb(0 0 0 / 0.15); flex-grow:1; position:relative; min-height:calc(100vh - 140px); }
    label { display:block; font-weight:600; margin-top:1em; margin-bottom:0.3em; }
    input[type="text"], input[type="email"], textarea { width:100%; padding:0.6em; font-size:1.1em; border:2px solid #ccc; border-radius:5px; transition:border-color 0.3s ease; box-sizing:border-box; }
    input:focus, textarea:focus { border-color:#007acc; outline:none; }
    button { border-radius:5px; cursor:pointer; font-weight:700; display:block; margin:1em auto 0 auto; }
    #btnConsultar { padding:0.5em 1em; font-size:1em; background:#2d8390; color:white; border:none; }
    #btnReclamo { padding:0.425em 0.85em; font-size:0.85em; background:#2d8390; color:white; border:none; }
    #btnVerExamen { padding:0.5em 1em; font-size:1em; background:#e07b7b; color:white; border:none; border-radius:5px; margin-top:1em; }
    #btnConsultar:hover, #btnReclamo:hover, #btnVerExamen:hover, #enviarReclamo:hover { opacity:0.9; }
    #resultado { margin-top:0.8em; font-size:1.15em; line-height:1.5; color:#000; white-space:pre-wrap; word-wrap:break-word; overflow-wrap:break-word; width:100%; box-sizing:border-box; }
    table { margin-top:0.3em; border-collapse:collapse; width:100%; }
    table, th, td { border:1px solid #ddd; }
    th, td { padding:0.6em 0.9em; text-align:center; }
    th { background-color:#f5f5f5; font-weight:700; }
    #error { color:#cc0000; font-weight:700; margin-top:1.5em; }
    .tabla-scroll { overflow-x:auto; max-width:100%; }
    .tabla-scroll table { min-width:600px; }
    footer { background:#38828f; color:white; text-align:center; padding:1em; font-size:0.9em; }
    #loader { display:none; text-align:center; margin-top:20px; font-size:2em; font-weight:bold; color:black; font-family:monospace; letter-spacing:0.2em; }
    @keyframes puntos { 0% { opacity:0; } 50% { opacity:1; } 100% { opacity:0; } }
    #loader span { opacity:0; animation-name:puntos; animation-duration:1.5s; animation-iteration-count:infinite; }
    #loader span:nth-child(1) { animation-delay:0s; }
    #loader span:nth-child(2) { animation-delay:0.3s; }
    #loader span:nth-child(3) { animation-delay:0.6s; }

    /* Marca de agua en tabla */
    #resultado table tbody td {
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="60" height="12"><text x="0" y="10" font-family="Segoe UI" font-size="7" fill="%23666666" fill-opacity="0.15">ToxicologíaUNLP</text></svg>');
      background-repeat: repeat;
      background-position: 0 0;
      background-size: 60px 12px;
    }

    /* Modal */
    .overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); display:none; justify-content:center; align-items:center; z-index:99999; }
    .modal { background:white; padding:20px; border-radius:10px; max-width:600px; width:100%; max-height:90%; overflow-y:auto; text-align:center; box-shadow:0 4px 10px rgba(0,0,0,0.3); border:5px solid #38828f; position:relative; }
    .modal input, .modal textarea { margin-top:5px; }
    .modal textarea { height:80px; }

    /* Marca de agua PDF */
    .watermark-container { position:relative; width:100%; height:600px; margin-top:1em; }
    .watermark-iframe { width:100%; height:100%; border:none; position:relative; z-index:1; pointer-events:none; }
    .watermark-text { position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); z-index:2; text-align:center; font-size:1.1em; color:rgba(100,0,0,0.45); pointer-events:none; line-height:1.4em; font-weight:bold; }
    .watermark-text p { margin:0.2em 0; }
    .close-pdf { position:absolute; top:10px; right:10px; z-index:3; font-size:1.5em; font-weight:bold; background:white; border:none; cursor:pointer; border-radius:5px; padding:2px 8px; }

    @media screen and (max-width:600px) { main { margin:1em; padding:1.2em; } #resultado { font-size:1em; } .watermark-container { height:400px; } .watermark-text { font-size:0.9em; } }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
</head>
<body>
  <header>
    <img src="logop.png" alt="Logo Cátedra" />
    <div class="titulo-centro">PLATAFORMA DE CALIFICACIONES</div>
  </header>

  <main id="contenido"></main>

  <footer>© 2025 Cátedra de Toxicología, Facultad de Ciencias Médicas - UNLP.</footer>

  <!-- Modal Reclamo -->
  <div class="overlay" id="modalReclamo">
    <div class="modal">
      <span id="cerrarModal" style="position:absolute; top:10px; right:15px; font-size:1.5em; font-weight:bold; cursor:pointer;">&times;</span>
      <h2>Formulario de Consulta / Reclamo</h2>
      <p id="codigoReclamo" style="font-weight:bold;"></p>
      <label>Alumno</label><input type="text" id="modalNombre" />
      <label>Legajo</label><input type="text" id="modalLegajo" />
      <label>Motivo de la consulta/reclamo</label><textarea id="modalMotivo"></textarea>
      <button id="enviarReclamo">Enviar</button>
      <p style="font-size:0.8em; color:#555; margin-top:5px;">Al presionar "Enviar" debe finalizar el proceso enviando el reclamo desde su correo electrónico.</p>
    </div>
  </div>

  <script>
    const urlBase = 'TU_URL_DE_SHEETS_PUBLICO_CSV_AQUI';
    let examenAbierto = false;

    async function cargarDatos(url) {
      const response = await fetch(url);
      const text = await response.text();
      return Papa.parse(text, { header:true, skipEmptyLines:true, delimiter:"," });
    }

    async function verificarEstado() {
      try {
        const datos = await cargarDatos(urlBase+'&_ts='+Date.now());
        const estado = datos.data[0]?.Estado?.trim().toLowerCase();
        const contenido = document.getElementById('contenido');
        if(estado==='habilitado'){
          contenido.innerHTML=`
            <p style="color:black; margin:0.5em 0;">Ingrese sus datos y el sistema le brindará la información.</p>
            <label for="legajo">Legajo</label><input type="text" id="legajo" placeholder="12345/6" autocomplete="off" />
            <label for="email">Correo electrónico asociado al SIU Guaraní*</label><input type="email" id="email" placeholder="alumno@gmail.com" autocomplete="off" />
            <small style="color:#555; font-size:0.9em;">*Correo electrónico oficial</small>
            <button id="btnConsultar">Ver Calificaciones</button>
            <div id="loader"><span>.</span><span>.</span><span>.</span></div>
            <div id="resultado"></div><div id="error"></div>
          `;
          document.getElementById('btnConsultar').addEventListener('click', buscarNota);
        } else {
          contenido.innerHTML=`<p style="color:red; font-weight:bold; font-size:1.2em; text-align:center;">La plataforma no se encuentra habilitada en este momento.</p>`;
        }
      } catch(e){ console.error("Error:",e); }
    }

    async function buscarNota() {
      if(examenAbierto) return;
      const legajoInput = document.getElementById('legajo').value.trim();
      const emailInput = document.getElementById('email').value.trim().toLowerCase();
      const resultado = document.getElementById('resultado');
      const loader = document.getElementById('loader');
      resultado.innerHTML=''; loader.style.display='block';

      try {
        const parsed = await cargarDatos(urlBase+'&_ts='+Date.now());
        const fila = parsed.data.find(row=> row['Legajo']?.trim()===legajoInput && row['Email']?.trim().toLowerCase()===emailInput );
        loader.style.display='none';
        if(!fila){ document.getElementById('error').textContent="Datos incorrectos."; return; }

        const nombre = fila['Nombre'] || fila['nombre'] || 'Alumno';
        let tablaHTML=`<p><strong>${nombre}, tus calificaciones son:</strong></p>`;
        tablaHTML+=`<div class="tabla-scroll"><table><thead><tr>`;
        Object.keys(fila).forEach(col=>{ if(!['legajo','nombre','email','estado','examenPdf'].includes(col.toLowerCase())) tablaHTML+=`<th>${col}</th>`; });
        tablaHTML+=`</tr></thead><tbody><tr>`;
        Object.keys(fila).forEach(col=>{ if(!['legajo','nombre','email','estado','examenPdf'].includes(col.toLowerCase())) tablaHTML+=`<td>${fila[col]}</td>`; });
        tablaHTML+=`</tr></tbody></table></div>`;
        tablaHTML+=`<button id="btnVerExamen">Ver Examen</button>`;
        resultado.innerHTML=tablaHTML;

        document.getElementById('btnVerExamen').addEventListener('click', ()=>{
          if(examenAbierto) return;
          examenAbierto=true;
          const container = document.createElement('div');
          container.classList.add('watermark-container');
          container.innerHTML=`
            <button class="close-pdf">&times;</button>
            <iframe class="watermark-iframe" src="${fila['examenPdf']}" sandbox="allow-same-origin allow-scripts"></iframe>
            <div class="watermark-text"><p>${nombre}</p><p>${legajoInput}</p><p>Distribuir este archivo es ilegal y conlleva a sanciones universitarias</p></div>
          `;
          resultado.appendChild(container);
          container.querySelector('.close-pdf').addEventListener('click', ()=>{ container.remove(); });
        });

      } catch(e){ loader.style.display='none'; console.error(e); }
    }

    document.addEventListener('DOMContentLoaded', verificarEstado);
  </script>
</body>
</html>









