<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Asistencia y Calificaciones - Toxicolog칤a UNLP</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<link rel="icon" href="logo1.png" type="image/png" />

<link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700;800&display=swap" rel="stylesheet">

<style>
* { box-sizing: border-box; }
html, body { height: 100%; margin: 0; }

body {
  font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
  background: linear-gradient(135deg, #087882 0%, #0c8c9c 40%, #045c63 70%, #04545d 100%);
  min-height: 100vh; display: flex; flex-direction: column; overflow-x: hidden;
}

main {
  max-width: 600px; width: 100%; background: #f9f8f5; margin: 30px auto 2em auto;
  padding: 2em; border-radius: 16px; box-shadow: 0 8px 25px rgba(0,0,0,0.2); flex: 1;
}

main header { text-align: center; margin-bottom: 25px; }
main header img { width: 100%; height: auto; border-radius: 16px; cursor: pointer; transition: transform 0.3s; }
main header img:active { transform: scale(0.95); }

.titulo-centro { font-family: 'Open Sans', sans-serif; font-weight: 700; font-size: 2em; color: #38828f; margin: 20px 0 0 0; }

label { font-weight: 600; margin-top: 1em; margin-bottom: 0.6em; display: block; }
input { width: 100%; padding: 0.7em; font-size: 1.05em; border: 2px solid #ccc; border-radius: 8px; }

button { border-radius: 6px; font-weight: 700; cursor: pointer; margin: 1em auto 0 auto; display: block; border: none; transition: 0.2s; }
#btnConsultar, #btnVolver, #btnDocente { background: #2d8390; color: white; padding: 0.6em 1.5em; }
.btn-admin { background: #444 !important; margin-top: 20px; font-size: 0.8em; }

/* PANEL DOCENTE */
#panelDocente { display: none; background: #ececec; padding: 1.5em; border-radius: 12px; border: 2px dashed #38828f; margin-top: 10px; }
.admin-badge { background: #38828f; color: white; padding: 4px 10px; border-radius: 4px; font-size: 0.7em; margin-bottom: 10px; display: inline-block; }

.categoria-bloque { margin-bottom: 15px; background: #fff; border-radius: 10px; padding: 15px; border: 1px solid #e0e6e7; border-left: 5px solid #38828f; }
.categoria-titulo { font-family: 'Montserrat', sans-serif; font-size: 0.85em; color: #38828f; font-weight: 800; margin-bottom: 12px; text-transform: uppercase; }
.grid-datos { display: grid; grid-template-columns: repeat(auto-fill, minmax(75px, 1fr)); gap: 8px; }
.dato-item { background: #f4f8f9; border: 1px solid #d1dfe1; padding: 10px 4px; border-radius: 6px; text-align: center; }
.dato-label { display: block; font-size: 0.65em; color: #668a90; font-weight: 700; }
.dato-valor { display: block; font-size: 1.1em; font-weight: 800; color: #2c565d; }

.promocion { background-color: #e8f5e9 !important; border-color: #a5d6a7 !important; }
.promocion .dato-valor { color: #2e7d32 !important; }
.desaprobado { background-color: #ffebee !important; border-color: #ef9a9a !important; }
.desaprobado .dato-valor { color: #c62828 !important; }

/* SELLO */
.sello-contenedor { display: flex; justify-content: center; margin: 30px 0 10px 0; }
.sello-verificado { position: relative; padding: 10px 25px; background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(5px); border-radius: 4px; border: 1px solid #cddde0; overflow: hidden; text-align: center; }
.sello-verificado::after { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: linear-gradient(45deg, transparent 45%, rgba(255, 255, 255, 0.8) 50%, transparent 55%); transform: rotate(25deg); animation: brilloHolografico 4s infinite; }
.sello-texto { font-family: 'Montserrat', sans-serif; font-size: 0.8em; font-weight: 700; color: #557b81; letter-spacing: 1.5px; text-transform: uppercase; position: relative; z-index: 1; }

@keyframes brilloHolografico { 0% { left: -100%; } 20% { left: 100%; } 100% { left: 100%; } }

.seccion-referencias { margin-top: 20px; padding: 12px; background: #eee; border-radius: 8px; font-size: 0.75em; color: #666; }
.info-institucional { margin-top: 1.5em; text-align: center; font-size: 0.74em; color: #888; }
footer { color: #ffffff; text-align: center; padding: 1em; font-size: 0.85em; margin-top: auto; }

#loader { display: none; text-align: center; padding: 2em 0; }
.spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #38828f; border-radius: 50%; animation: spin 1s linear infinite; margin: auto; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
</head>

<body>
<main>
  <header>
    <img src="logop.png" alt="Logo C치tedra" id="logoAdmin" title="Acceso Institucional" />
    <div class="titulo-centro">ASISTENCIA Y CALIFICACIONES</div>
  </header>

  <div id="contenido"></div>
  
  <div id="panelDocente">
    <span class="admin-badge">MODO DOCENTE</span>
    <label>Buscar por Legajo (solo n칰meros):</label>
    <input type="text" id="legajoDocente" placeholder="Ej: 123456" />
    <button id="btnDocente" onclick="busquedaDocente()">Consultar Alumno</button>
  </div>

  <div id="loader"><div class="spinner"></div></div>
  <div id="resultado"></div>
  <div id="error" style="color:red; text-align:center; margin-top:10px;"></div>
</main>

<footer>춸 2026 C치tedra de Toxicolog칤a, FCM - UNLP.</footer>

<script>
const urlBase = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vReNWOvv7g2rK58C0Ari6MtMo8LT1Si1hYRm_hueR-ad88Utj6TlK0wfMyJJEHv1Q/pub?output=csv';
const urlEdicion = 'https://docs.google.com/spreadsheets/d/1vReNWOvv7g2rK58C0Ari6MtMo8LT1Si1hYRm_hueR-ad88Utj6TlK0wfMyJJEHv1Q/edit'; // Link para editar

async function cargarDatos() {
  const res = await fetch(urlBase + '&_ts=' + Date.now(), { cache: "no-store" });
  const text = await res.text();
  return Papa.parse(text, { header: true, skipEmptyLines: true });
}

async function verificarEstado() {
  const datos = await cargarDatos();
  const filaEstado = datos.data.find(row => row.Estado?.trim() !== "");
  if (filaEstado?.Estado?.toLowerCase().trim() === 'habilitado') {
    document.getElementById('contenido').innerHTML = `
      <div id="formBuscador">
        <label>Legajo</label><input type="text" id="legajo" placeholder="12345/6" />
        <label>E-mail SIU Guaran칤</label><input type="email" id="email" placeholder="alumno@gmail.com" />
        <button id="btnConsultar" onclick="buscarNota()">Acceder</button>
      </div>`;
  } else {
    document.getElementById('contenido').innerHTML = '<p style="text-align:center">Acceso no habilitado.</p>';
  }
}

// L칩gica Acceso Docente
document.getElementById('logoAdmin').addEventListener('click', () => {
  const clave = prompt("Ingrese clave de acceso docente:");
  if (clave === "4321") {
    document.getElementById('formBuscador')?.remove();
    document.getElementById('panelDocente').style.display = 'block';
  }
});

async function busquedaDocente() {
  const input = document.getElementById('legajoDocente').value.trim();
  if(!input) return;
  mostrarResultado(input, true);
}

async function buscarNota() {
  const leg = document.getElementById('legajo').value.trim().toLowerCase();
  const mail = document.getElementById('email').value.trim().toLowerCase();
  if(!leg || !mail) return;
  mostrarResultado(leg, false, mail);
}

async function mostrarResultado(busqueda, esDocente, mail = "") {
  document.getElementById('loader').style.display = 'block';
  document.getElementById('resultado').innerHTML = "";
  const parsed = await cargarDatos();
  
  const fila = parsed.data.find(row => {
    const legajoExcel = row['Legajo']?.toString().toLowerCase().replace(/[^0-9]/g, '');
    const legajoBusqueda = busqueda.replace(/[^0-9]/g, '');
    if (esDocente) return legajoExcel === legajoBusqueda;
    return legajoExcel === legajoBusqueda && row['Email']?.trim().toLowerCase() === mail;
  });

  document.getElementById('loader').style.display = 'none';
  if(!fila) { alert("No se encontraron datos."); return; }

  if(!esDocente) document.getElementById('formBuscador').style.display = 'none';

  let html = `<p><strong>${fila['Apellido y Nombre'] || 'Estudiante'}:</strong></p>`;
  html += generarBloque(fila, "T", "Te칩ricos");
  html += generarBloque(fila, "P", "Trabajos Pr치cticos", ["춿", "F", "PARCIAL", "PFI"]);
  html += generarBloque(fila, "S", "Simulaci칩n");
  html += generarBloque(fila, "AE", "Autoevaluaciones");
  html += generarBloqueEvaluacion(fila);
  
  if(esDocente) {
    html += `<button class="btn-admin" onclick="window.open('${urlEdicion}')">游 Modificar en Planilla</button>`;
  } else {
    html += `<div class="sello-contenedor"><div class="sello-verificado"><div class="sello-texto">Informaci칩n Verificada</div></div></div>
             <button id="btnVolver" onclick="location.reload()">Volver</button>`;
  }
  
  document.getElementById('resultado').innerHTML = html;
}

function aplicarLogicaColores(valor, esEval) {
  if(!valor) return "";
  const v = valor.trim().toUpperCase();
  if (v === "A") return esEval ? "promocion" : "desaprobado";
  if (v === "P") return "promocion";
  if (v === "D") return "desaprobado";
  const n = parseFloat(v);
  return !isNaN(n) ? (n >= 4 ? "promocion" : "desaprobado") : "";
}

function generarBloque(fila, pref, tit, excl = []) {
  const cols = Object.keys(fila).filter(k => k.startsWith(pref) && !excl.some(e => k.includes(e)) && fila[k]?.trim() !== "");
  if(!cols.length) return "";
  let b = `<div class="categoria-bloque"><div class="categoria-titulo">${tit}</div><div class="grid-datos">`;
  cols.forEach(c => b += `<div class="dato-item ${aplicarLogicaColores(fila[c], false)}"><span class="dato-label">${c}</span><span class="dato-valor">${fila[c]}</span></div>`);
  return b + `</div></div>`;
}

function generarBloqueEvaluacion(fila) {
  const cols = Object.keys(fila).filter(k => (k.includes("춿") || k.includes("F") || k.includes("PARCIAL") || k.startsWith("PFI") || k.startsWith("TECP")) && fila[k]?.trim() !== "");
  if(!cols.length) return "";
  let b = `<div class="categoria-bloque"><div class="categoria-titulo">EVALUACIONES</div><div class="grid-datos">`;
  cols.forEach(c => b += `<div class="dato-item ${aplicarLogicaColores(fila[c], true)}"><span class="dato-label">${c}</span><span class="dato-valor">${fila[c]}</span></div>`);
  return b + `</div></div>`;
}

window.onload = verificarEstado;
</script>
</body>
</html>


















































































































































































































































































































































































































































































































































































































































































































































































































































































































