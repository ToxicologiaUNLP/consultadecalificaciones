<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Notas Toxicología UNLP</title>
  <link rel="icon" href="logo2.png" type="image/png">
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;800&display=swap" rel="stylesheet">
  <style>
    /* ... estilos originales ... */
    #alerta {
      margin: 1em 0;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
</head>
<body>
  <header>
    <img src="logo.png" alt="Logo Cátedra" class="logo-izq" />
    <h1 class="titulo-centro">Plataforma de acceso a calificaciones</h1>
    <img src="logo1.png" alt="Logo Derecho" class="logo-der pequeño" />
  </header>

  <main>
    <div id="alerta"></div>
    <p>El sistema solo muestra resultados si coincide la información brindada.</p>

    <label for="legajo">Ingrese su legajo:</label>
    <input type="text" id="legajo" placeholder="12345/6" autocomplete="off" />

    <label for="email">Ingrese su email asociado al SIU Guaraní*:</label>
    <input type="email" id="email" placeholder="alumno@gmail.com" autocomplete="off" />
    <small style="color:#555; font-size:0.9em;">
      *Correo electrónico que usted ha seleccionado para recibir información oficial de las cátedras.
    </small>

    <button onclick="buscarNota()">Consultar</button>
    <div id="resultado"></div>
    <div id="error"></div>
  </main>

  <footer>
    © 2025 Cátedra de Toxicología, Facultad de Ciencias Médicas - UNLP. Todos los derechos reservados.
  </footer>

  <script>
    const urlBase = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vReNWOvv7g2rK58C0Ari6MtMo8LT1Si1hYRm_hueR-ad88Utj6TlK0wfMyJJEHv1Q/pub?gid=919817434&single=true&output=csv';
    const urlConfig = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vReNWOvv7g2rK58C0Ari6MtMo8LT1Si1hYRm_hueR-ad88Utj6TlK0wfMyJJEHv1Q/pub?gid=ID_DE_LA_HOJA_CONFIGURACION&single=true&output=csv';

    // Mostrar cartel si hay actualizaciones
    fetch(urlConfig + '&_ts=' + Date.now())
      .then(res => res.text())
      .then(csvText => {
        const parsed = Papa.parse(csvText, { header: true, skipEmptyLines: true });
        if (parsed.data.length && parsed.data[0].ultimaActualizacion) {
          let fechaSheet = parsed.data[0].ultimaActualizacion.trim();
          let ultimaVez = localStorage.getItem("ultimaFechaNotas");

          if (ultimaVez !== fechaSheet) {
            document.getElementById("alerta").innerHTML =
              '<div style="background-color: #4CAF50; color: white; padding: 10px; text-align: center; font-weight: bold;">Hay calificaciones actualizadas</div>';
            localStorage.setItem("ultimaFechaNotas", fechaSheet);
          }
        }
      });

    function cargarDatos(url) {
      return fetch(url)
        .then(response => response.text())
        .then(csvText => Papa.parse(csvText, { header: true, skipEmptyLines: true, delimiter: "," }));
    }

    async function buscarNota() {
      const legajoInput = document.getElementById('legajo').value.trim().toLowerCase();
      const emailInput = document.getElementById('email').value.trim().toLowerCase();
      const resultado = document.getElementById('resultado');
      const errorDiv = document.getElementById('error');
      resultado.innerHTML = "";
      errorDiv.textContent = "";

      if (!legajoInput || !emailInput) {
        errorDiv.textContent = "Por favor, ingrese legajo y email.";
        return;
      }

      try {
        const parsed = await cargarDatos(urlBase + '&_ts=' + Date.now());
        const columnas = parsed.meta.fields;
        const fila = parsed.data.find(row =>
          row['Legajo'] && row['Email'] &&
          row['Legajo'].trim().toLowerCase() === legajoInput &&
          row['Email'].trim().toLowerCase() === emailInput
        );

        if (!fila) {
          errorDiv.textContent = "Datos incorrectos. Verifique legajo/email.";
          return;
        }

        const nombre = fila['Alumno'] || "Alumno";
        const columnasExcluir = ['legajo', 'nombre', 'apellido', 'nombre y apellido', 'alumno', 'email'];

        let tablaHTML = `<p><strong>Hola ${nombre}, tus notas son:</strong></p><div class="tabla-scroll"><table><thead><tr>`;
        columnas.forEach(col => {
          if (!columnasExcluir.includes(col.toLowerCase())) tablaHTML += `<th>${col}</th>`;
        });
        tablaHTML += '</tr></thead><tbody><tr>';
        columnas.forEach(col => {
          if (!columnasExcluir.includes(col.toLowerCase())) tablaHTML += `<td>${fila[col] || '-'}</td>`;
        });
        tablaHTML += '</tr></tbody></table></div>';
        tablaHTML += '<p style="margin-top:2em; color:#000; font-size:0.95em;">Contacto: <strong>toxicoalumnos@gmail.com</strong></p>';
        resultado.innerHTML = tablaHTML;
      } catch {
        errorDiv.textContent = "Error al cargar los datos. Intente nuevamente.";
      }
    }
  </script>
</body>
</html>

