<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Notas Toxicología UNLP</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="icon" href="logo1.png" type="image/png" />
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;800&display=swap" rel="stylesheet">

  <style>
    html, body { height:100%; width:100%; margin:0; padding:0; }
    body { font-family:"Segoe UI", Tahoma, Geneva, Verdana, sans-serif; background:#f9f9f9; display:flex; flex-direction:column; min-height:100vh; }
    header { display:flex; flex-direction:column; justify-content:center; align-items:center; padding:20px; }
    header img { width:100%; max-width:660px; height:auto; }
    .titulo-centro { font-family:'Open Sans', sans-serif; font-weight:700; font-size:2.2em; color:#38828f; text-align:center; margin:20px 0 0 0; line-height:1.2em; user-select:none; }
    main { max-width:600px; background:white; margin:0 auto 2em auto; padding:2em; border-radius:10px; box-shadow:0 2px 8px rgb(0 0 0 / 0.15); flex-grow:1; position:relative; min-height:calc(100vh - 140px); }
    label { display:block; font-weight:600; margin-top:1em; margin-bottom:0.3em; }
    input[type="text"], input[type="email"], textarea { width:100%; padding:0.6em; font-size:1.1em; border:2px solid #ccc; border-radius:5px; transition:border-color 0.3s ease; box-sizing:border-box; }
    input[type="text"]:focus, input[type="email"]:focus, textarea:focus { border-color:#007acc; outline:none; }
    button { border-radius:5px; cursor:pointer; font-weight:700; display:block; margin:1em auto 0 auto; }
    #btnConsultar { padding:0.5em 1em; font-size:1em; background:#2d8390; color:white; border:none; }
    #btnReclamo { padding:0.425em 0.85em; font-size:0.85em; background:#2d8390; color:white; border:none; }
    #btnVerExamen { padding:0.5em 1em; font-size:1em; background:#d46b6b; color:white; border:none; }
    #btnConsultar:hover, #btnReclamo:hover, #btnVerExamen:hover, #enviarReclamo:hover { opacity:0.9; }
    #resultado { margin-top:0.8em; font-size:1.15em; line-height:1.5; color:#000; white-space:pre-wrap; word-wrap:break-word; overflow-wrap:break-word; width:100%; box-sizing:border-box; }
    @media screen and (max-width:600px) { main { margin:1em; padding:1.2em; } #resultado { font-size:1em; } }
    #resultado strong { color:#000; }
    table { margin-top:0.3em; border-collapse:collapse; width:100%; }
    table, th, td { border:1px solid #ddd; }
    th, td { padding:0.6em 0.9em; text-align:center; }
    th { background-color:#f5f5f5; font-weight:700; }
    #error { color:#cc0000; font-weight:700; margin-top:1.5em; }
    .tabla-scroll { overflow-x:auto; max-width:100%; }
    .tabla-scroll table { min-width:600px; }
    footer { background:#38828f; color:white; text-align:center; padding:1em; font-size:0.9em; }
    #loader { display:none; text-align:center; margin-top:20px; font-size:2em; font-weight:bold; color:black; font-family:monospace; letter-spacing:0.2em; }
    @keyframes puntos { 0% {opacity:0;} 50% {opacity:1;} 100% {opacity:0;} }
    #loader span { opacity:0; animation-name:puntos; animation-duration:1.5s; animation-iteration-count:infinite; }
    #loader span:nth-child(1){animation-delay:0s;} #loader span:nth-child(2){animation-delay:0.3s;} #loader span:nth-child(3){animation-delay:0.6s;}
    #resultado table tbody td { background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="60" height="12"><text x="0" y="10" font-family="Segoe UI" font-size="7" fill="%23666666" fill-opacity="0.25">ToxicologíaUNLP</text></svg>'); background-repeat: repeat; background-position: 0 0; background-size: 60px 12px; }

    /* Modal */
    .overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); display:none; justify-content:center; align-items:center; z-index:99999; }
    .modal { background:white; padding:20px; border-radius:10px; max-width:600px; width:100%; max-height:90%; overflow-y:auto; text-align:center; box-shadow:0 4px 10px rgba(0,0,0,0.3); border:5px solid #38828f; position:relative; }
    .modal input, .modal textarea { margin-top:5px; }
    .modal textarea { height:80px; }

    /* PDF.js viewer */
    #visorPDF { width:100%; height:80vh; position:relative; overflow:auto; background:#ccc; }
    canvas.pdfPage { display:block; margin:1em auto; position:relative; }
    .marcaAguaPDF { position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); color:rgba(255,0,0,0.25); font-size:24px; font-weight:bold; text-align:center; pointer-events:none; user-select:none; width:80%; white-space:pre-wrap; z-index:1000; }
  </style>

  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.9.179/pdf.min.js"></script>
</head>
<body>
  <header>
    <img src="logop.png" alt="Logo Cátedra" />
    <div class="titulo-centro">PLATAFORMA DE CALIFICACIONES</div>
  </header>

  <main id="contenido"></main>
  <footer>© 2025 Cátedra de Toxicología, Facultad de Ciencias Médicas - UNLP.</footer>

  <!-- Modal Reclamo -->
  <div class="overlay" id="modalReclamo">
    <div class="modal">
      <span id="cerrarModal" style="position:absolute; top:10px; right:15px; font-size:1.5em; font-weight:bold; cursor:pointer;">&times;</span>
      <h2>Formulario de Consulta / Reclamo</h2>
      <p id="codigoReclamo" style="font-weight:bold;"></p>
      <label>Alumno</label>
      <input type="text" id="modalNombre" />
      <label>Legajo</label>
      <input type="text" id="modalLegajo" />
      <label>Motivo de la consulta/reclamo</label>
      <textarea id="modalMotivo"></textarea>
      <button id="enviarReclamo">Enviar</button>
      <p style="font-size:0.8em; color:#555; margin-top:5px;">Al presionar "Enviar" debe finalizar el proceso enviando el reclamo desde su correo electrónico.</p>
    </div>
  </div>

  <!-- Modal Examen PDF -->
  <div class="overlay" id="modalExamen">
    <div class="modal" style="position:relative; padding:10px;">
      <span id="cerrarExamen" style="position:absolute; top:5px; right:10px; font-size:1.5em; font-weight:bold; cursor:pointer; z-index:10;">&times;</span>
      <div id="visorPDF"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <script>
    const urlBase = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vReNWOvv7g2rK58C0Ari6MtMo8LT1Si1hYRm_hueR-ad88Utj6TlK0wfMyJJEHv1Q/pub?gid=919817434&single=true&output=csv';
    let examenAbierto = false;

    async function cargarDatos(url) {
      const response = await fetch(url);
      const text = await response.text();
      return Papa.parse(text, { header:true, skipEmptyLines:true, delimiter:"," });
    }

    async function verificarEstado() {
      try {
        const datos = await cargarDatos(urlBase + '&_ts=' + Date.now());
        const estado = datos.data[0]?.Estado?.trim().toLowerCase();
        const contenido = document.getElementById('contenido');

        if(estado === 'habilitado'){
          contenido.innerHTML = `
            <p style="color:black; margin:0.5em 0;">Ingrese sus datos de la forma solicitada y el sistema le brindará la información.</p>
            <label for="legajo">Legajo</label>
            <input type="text" id="legajo" placeholder="12345/6" autocomplete="off" />
            <label for="email">Correo electrónico asociado al SIU Guaraní*</label>
            <input type="email" id="email" placeholder="alumno@gmail.com" autocomplete="off" />
            <small style="color:#555; font-size:0.9em;">*Correo electrónico que usted ha seleccionado para recibir información oficial de las cátedras.</small>
            <button id="btnConsultar">Ver Calificaciones</button>
            <div id="loader"><span>.</span><span>.</span><span>.</span></div>
            <div id="resultado"></div>
            <div id="error"></div>
          `;
          const legajoInput = document.getElementById('legajo');
          const emailInput = document.getElementById('email');
          const btnConsultar = document.getElementById('btnConsultar');
          [legajoInput,emailInput].forEach(input => { input.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); buscarNota(); } }); });
          btnConsultar.addEventListener('click', buscarNota);
        } else {
          contenido.innerHTML = `<p style="color:red; font-weight:bold; font-size:1.2em; text-align:center;">La plataforma no se encuentra habilitada en este momento.</p>`;
        }
      } catch(e){
        console.error("Error al verificar estado:", e);
        document.getElementById('contenido').innerHTML = `<p style="color:red; font-weight:bold; font-size:1.2em; text-align:center;">No se pudo verificar el estado de la plataforma. Intente nuevamente más tarde.</p>`;
      }
    }

    async function buscarNota(){
      const legajoInput = document.getElementById('legajo').value.trim().toLowerCase();
      const emailInput = document.getElementById('email').value.trim().toLowerCase();
      const resultado = document.getElementById('resultado');
      const errorDiv = document.getElementById('error');
      const loader = document.getElementById('loader');
      resultado.innerHTML = ""; errorDiv.textContent = "";
      if(!legajoInput || !emailInput){ errorDiv.textContent="Por favor, ingrese los datos requeridos."; return; }
      loader.style.display="block";

      try{
        const parsed = await cargarDatos(urlBase + '&_ts=' + Date.now());
        const columnas = parsed.meta.fields;
        const fila = parsed.data.find(row=> row['Legajo'] && row['Email'] && row['Legajo'].trim().toLowerCase()===legajoInput && row['Email'].trim().toLowerCase()===emailInput );

        loader.style.display="none";
        if(!fila){ errorDiv.textContent="Datos incorrectos. Verifique e intente nuevamente."; return; }

        const primeraColumna = columnas[0];
        const nombre = fila[primeraColumna] || "Alumno";
        const columnasExcluir = ['legajo','nombre','apellido','nombre y apellido','alumno','email','estado', primeraColumna.toLowerCase(), 'examenpdf'];
        const columnasVisibles = columnas.filter(col=> !columnasExcluir.includes(col.toLowerCase()) && fila[col] && fila[col].trim()!=='');
        let tablaHTML = `<p><strong>${nombre}, tus calificaciones son:</strong></p><div class="tabla-scroll"><table><thead><tr>`;
        columnasVisibles.forEach(col=>{ tablaHTML += `<th>${col}</th>`; });
        tablaHTML += `</tr></thead><tbody><tr>`;
        columnasVisibles.forEach(col=>{ tablaHTML += `<td>${fila[col]}</td>`; });
        tablaHTML += `</tr></tbody></table></div>`;

        if(fila['examenPdf'] && fila['examenPdf'].trim()!==''){
          tablaHTML += `<button id="btnVerExamen">Ver Examen</button>`;
        }
        tablaHTML += `<button id="btnReclamo">Consulta / Reclamo</button>`;
        resultado.innerHTML = tablaHTML;

        // Reclamo
        const btnReclamo = document.getElementById('btnReclamo');
        btnReclamo.addEventListener('click', ()=>{
          const modal = document.getElementById('modalReclamo');
          modal.style.display='flex';
          const codigo='RC-'+Math.floor(Math.random()*1000000);
          document.getElementById('codigoReclamo').textContent=`Código de reclamo: ${codigo}`;
          document.getElementById('modalNombre').value=nombre;
          document.getElementById('modalLegajo').value=fila['Legajo'];
        });
        document.getElementById('enviarReclamo').addEventListener('click', ()=>{
          const nombreModal=document.getElementById('modalNombre').value;
          const legajoModal=document.getElementById('modalLegajo').value;
          const motivoModal=document.getElementById('modalMotivo').value;
          const codigo=document.getElementById('codigoReclamo').textContent.split(': ')[1];
          const body=`Código de reclamo: ${codigo}%0AAlumno: ${encodeURIComponent(nombreModal)}%0ALegajo: ${encodeURIComponent(legajoModal)}%0AMotivo: ${encodeURIComponent(motivoModal)}`;
          window.location.href=`mailto:toxicoalumnos@gmail.com?subject=Consulta/Reclamo%20-%20Plataforma%20de%20Calificaciones&body=${body}`;
        });
        document.getElementById('cerrarModal').addEventListener('click', ()=>{ document.getElementById('modalReclamo').style.display='none'; });

        // Examen PDF
        const btnVerExamen=document.getElementById('btnVerExamen');
        if(btnVerExamen){
          btnVerExamen.addEventListener('click', async ()=>{
            if(examenAbierto) return alert("El examen solo puede abrirse una vez.");
            examenAbierto=true;
            const modalExamen=document.getElementById('modalExamen');
            const visor=document.getElementById('visorPDF');
            visor.innerHTML=''; // limpiar
            modalExamen.style.display='flex';

            // Cargar PDF
            const loadingTask = pdfjsLib.getDocument(fila['examenPdf']);
            const pdf = await loadingTask.promise;
            for(let i=1;i<=pdf.numPages;i++){
              const page = await pdf.getPage(i);
              const viewport = page.getViewport({scale:1.3});
              const canvas = document.createElement('canvas');
              canvas.className='pdfPage';
              canvas.width = viewport.width;
              canvas.height = viewport.height;
              visor.appendChild(canvas);
              const context = canvas.getContext('2d');
              await page.render({canvasContext:context, viewport:viewport}).promise;

              // Marca de agua
              const marca = document.createElement('div');
              marca.className='marcaAguaPDF';
              marca.textContent=`${nombre} - ${fila['Legajo']}\nDistribuir este archivo conlleva a sanciones Universitarias y/o Judiciales`;
              canvas.parentElement.appendChild(marca);
            }
          });
        }

        document.getElementById('cerrarExamen').addEventListener('click', ()=>{
          document.getElementById('modalExamen').style.display='none';
          document.getElementById('visorPDF').innerHTML='';
        });

      }catch(e){ loader.style.display="none"; console.error("Error al cargar datos:", e); errorDiv.textContent="Error al cargar los datos. Intente nuevamente."; }
    }

    document.addEventListener('DOMContentLoaded', verificarEstado);
  </script>
</body>
</html>










